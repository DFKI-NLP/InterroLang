<!-- This code is modified from a script provided in https://studygyaan.com/python/create-web-based-chatbot-in-python-django-flask -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>InterroLang</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="/static/styles/style.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>

    <script>
        function showTooltip(description) {
            const infobox = document.getElementById("infobox");
            infobox.style.visibility = "visible";
            infobox.innerHTML = description
        }

        function hideTooltip() {
            const infobox = document.getElementById("infobox");
            infobox.style.visibility = "hidden";
        }
    </script>
</head>

<body>
<messagebody>
    <!-- The text interaction part of the method -->
    <section class="ttm">
        <header class="ttm-header">
            <div class="ttm-header-title">
                InterroLang
            </div>
        </header>
        <main class="ttm-chat">
            <div class="msg left-msg">
                <div class="msg-bubble">
                    <div class="msg-text">
                        Hello üòä, I'm a machine learning model trained to {{ datasetObjective }}.
                        <br><br>
                        Let's get started. Ask me something!
                    </div>
                </div>
            </div>
        </main>

        <form class="ttm-inputarea">
            <select id="input_source" class="form-select"
                    style="width: 150px; text-align:center; font-family: Calibri; margin-right: 10px">
                <option style="text-align:center; " value="0">Input</option>
                <option style="text-align:center;" value="1">Custom input</option>
                <option style="text-align:center;" value="2">Include</option>
            </select>
            <input type="text" class="ttm-input" id="textInput"
                   placeholder="Enter your command! Use the ‚Üë arrow and ‚Üì arrow to cycle previous commands.">
            <button type="submit" class="ttm-send-btn">Send</button>
        </form>
        <span class="genOptions">üëáHelp me generate a question about...üëá</span>

        <div class="slideDown">
            <div id="infobox" style="visibility: hidden; color: red; font-style: italic"></div>
            <div class="dots-cont" id="generation-loading"><span class="dot dot-1"></span> <span
                    class="dot dot-2"></span> <span class="dot dot-3"></span></div>
            <div class="buttons" id="generation-buttons">

                <button title="args: topk (int, optional)" id="idea-important" class="idea-button" onclick="sampleImportant()">global
                    feature importances
                </button>
                <button title="args: id (int), topk (int, optional)" id="idea-why" class="idea-button" onclick="sampleWhy()">local feature importance explanation
                </button>
                <button id="idea-predict" class="idea-button" onclick="samplePredict()">predictions</button>

                <button id="idea-random-predict" class="idea-button" onclick="sampleRandomPredict()">random
                    prediction
                </button>

                <button id="idea-likelihood" class="idea-button" onclick="sampleLikelihood()">likelihood
                </button>
                <button id="idea-show" class="idea-button" onclick="sampleShow()">show data</button>
                <button id="idea-capabilities" class="idea-button" onclick="sampleCapabilities()">system capabilities
                </button>
                <button id="idea-performance" class="idea-button" onclick="samplePerformance()">performance</button>
                <button id="idea-flip" class="idea-button" onclick="sampleFlip()">counterfactual</button>
                <button id="idea-description" class="idea-button" onclick="sampleDataDescription()">data
                    description
                </button>
                <!--                    <button class="idea-button" onclick="sampleInteractions()">feature interaction effects</button>-->
                <button class="idea-button" onclick="sampleMistakes()">mistakes</button>
                <button class="idea-button" onclick="sampleLabels()">true labels</button>
                <button class="idea-button" onclick="sampleSimilar()">find a similar instance</button>
                <button class="idea-button" onclick="sampleRationalization()">rationalize</button>
                <button class="idea-button" onclick="sampleAdversarial()">adversarial</button>
                <button class="idea-button" onclick="sampleAugment()">augmentation</button>
                <button class="idea-button" onclick="sampleSentence()">sentence-level feature attribution</button>

                <button class="idea-button" id="c_pred" onclick="sampleCustomInputPrediction()">custom input
                    prediction
                </button>
                <button class="idea-button" id="c_feat" onclick="sampleCustomInputFeatureImportance()">custom input
                    feature
                    importance
                </button>
                <button title="args: custom_input (str)" onmouseover="showTooltip('sentence level feature attribution on custom input. Your custom input requires to be given before call this function')"
                        onmouseout="hideTooltip()"
                        class="idea-button" id="c_feat_sent"
                        onclick="sampleCustomInputFeatureImportanceOnSentenceLevel()">custom input
                    sentence importance
                </button>
            </div>
        </div>
        </main>

    </section>

    <div style="width: 500px; justify-content: start;">
        <div>
            <img src="{{url_for('static', filename='images/banner.png')}}" style="width: 400px; align-content: center;">
        </div>
        <div id="accordion">
            <div class="card">
                <div class="card-header" id="headingOne">
                    <h5 class="mb-0">
                        <button class="btn btn-link" data-toggle="collapse" data-target="#collapseOne"
                                aria-expanded="true" aria-controls="collapseOne" style="color: red">
                            ‚ö†Ô∏è Instructions:
                        </button>
                    </h5>
                </div>

                <div id="collapseOne" class="collapse" aria-labelledby="headingOne" data-parent="#accordion">
                    <div class="card-body">
                        <div class="panel panel-danger">
                            <div class="panel-heading"><b>"Input"</b>: enter <b>"quit"</b> can delete the entered custom
                                input if
                                available.
                            </div>
                            <div class="panel-heading"><b>"Custom input"</b>: add your own input instance. For BoolQ,
                                please
                                use
                                <b>"|"</b> to separate text and passage!
                            </div>
                            <div class="panel-heading"><b>"Include"</b>: enter a search term to filter the dataset.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <div style="margin-top: 10px">
            <!-- Filter dataset by string ("includes") -->
            <b>üîç Filter dataset by text:</b>
            <form class="filterdata-inputarea">
                <input type="text" class="filterdata-input" id="filterdataInput" placeholder="Filter dataset">
            </form>
        </div>
        <!-- Displaying data -->
        <!-- Referring jinja2 syntax -->
        <h1 style="font: small-caps bold 20px/1 sans-serif; margin-top: 10px">üóÉÔ∏è {{dataset}} dataset viewer </h1>
        <div id="show_data"
             style="border: thick #32a1ce double; width: 300px; border-radius: 15px; padding: 5px; overflow-y: scroll; height: 450px; width: 500px">
            {% for entry in entries %}
            {% if dataset == 'boolq' %}
            <details>
                <summary style="font-weight: bold;">ID: {{loop.index}}</summary>
                <b>question:</b> <br>
                <div style='font-style: italic; font-size: 0.75em;'>{{entry["question"]}}</div>
                <b>passage:</b> <br>
                <div style='font-style: italic; font-size: 0.75em;'>{{entry["passage"]}}</div>
            </details>
            {% elif dataset == 'daily_dialog' %}
            <details>
                <summary style="font-weight: bold;">ID: {{loop.index}}</summary>
                <b>dialog:</b>
                <div style='font-style: italic; font-size: 0.75em;'>{{entry["dialog"]}}</div>
            </details>
            {% else %}
            <details>
                <summary style="font-weight: bold;">ID: {{loop.index}}</summary>
                <b>text:</b> <br>
                <div style='font-style: italic; font-size: 0.75em;'>{{entry["text"]}}</div>
            </details>
            {% endif %}
            <br>
            {% endfor %}
            <br>(Showing first 10)
        </div>
        <div style="margin-top: 10px;">
            <!-- Reset temp dataset -->
            <div style="margin-top: 10px">
                <button type="button" class="btn btn-primary" id="reset_temp_dataset" style="width: 300px"
                        onclick="reset_temp_dataset()">Click me to reset the temp
                    dataset
                </button>
            </div>
        </div>
        <!--        <section class="pins" id="my-pins">-->
        <!--          <header class="pins-header">-->
        <!--            <div class="pins-header-title">-->
        <!--             Pins-->
        <!--            </div>-->
        <!--          </header>-->
        <!--            <main class="pins-scroll"> &lt;!&ndash; pinned messages appear here &ndash;&gt;-->
        <!--                <div class="pin left-msg">-->
        <!--                  <div class="pin-bubble">-->
        <!--                    <div class="pin-text">Pin messages and they will appear here!</div>-->
        <!--                  </div>-->
        <!--                </div>-->
        <!--            </main>-->
        <!--        </section>-->
</messagebody>
</body>
</html>

<script>
    $('.genOptions').click(function (e) {
        $('.slideDown').slideToggle();
    });
</script>

<script>

    function doSample(rawAction) {
        let username = '{{ currentUserId }}'
        let dataPackage = {action: rawAction, thisUserName: username}
        let jsonDataPackage = JSON.stringify(dataPackage)

        let button_div = document.getElementById("")

        const result = $.ajax({
            type: 'POST',
            url: "{{ url_for('.sample_prompt') }}",
            data: jsonDataPackage,
            processData: false,
            contentType: false,
            cache: false,
            success: function (data) {
                ttmInput.value = data;
            }
        });
    }

    function sampleSentence() {
        doSample("sentence");
    }

    function sampleAdversarial() {
        doSample("adversarial");
    }

    function sampleAugment() {
        doSample("augment");
    }

    function sampleCustomInputFeatureImportanceOnSentenceLevel() {
        doSample("custom_input_feature_importance_on_sentence_level");
    }

    function sampleCustomInputFeatureImportance() {
        doSample("custom_input_feature_importance");
    }

    function sampleCustomInputPrediction() {
        doSample("custom_input_prediction");
    }

    function sampleRandomPredict() {
        doSample("random_predict");
    }

    function sampleDataDescription() {
        doSample("description");
    }

    function samplePerformance() {
        doSample("score");
    }

    function sampleMistakes() {
        doSample("mistake");
    }

    function sampleFlip() {
        doSample("cfe");
    }

    function sampleRationalization() {
        doSample("rationalization");
    }

    function sampleImportant() {
        doSample("important");
    }

    function sampleLabels() {
        doSample("labels");
    }

    function sampleSimilar() {
        doSample("similar");
    }

    function sampleWhy() {
        doSample("explain");
    }

    function samplePredict() {
        doSample("predict");
    }

    function sampleLikelihood() {
        doSample("likelihood");
    }

    function sampleShow() {
        doSample("show");
    }

    function sampleCapabilities() {
        doSample("function");
    }

    function sampleInteractions() {
        doSample("interactions")
    }
</script>


<script src='https://use.fontawesome.com/releases/v5.0.13/js/all.js'></script>
<script>
    function reset_temp_dataset() {
        let username = '{{ currentUserId }}'
        let dataPackage = {thisUserName: username}
        let jsonDataPackage = JSON.stringify(dataPackage)

        const result = $.ajax({
            type: 'POST',
            url: "{{ url_for('.reset_temp_dataset') }}",
            data: jsonDataPackage,
            processData: false,
            contentType: false,
            cache: false,
        });
    }

</script>
<script>
    const ttmForm = get(".ttm-inputarea");
    const ttmInput = get(".ttm-input");
    const ttmChat = get(".ttm-chat");
    const ttmPins = get(".pins-scroll");
    let userInputs = [];
    let userInputIndex = 0;

    // text box command
    ttmForm.addEventListener("submit", event => {
        var idx = document.getElementById("input_source").selectedIndex;
        const msgText = ttmInput.value;
        let custom_input;

        event.preventDefault();

        if (!msgText) return;
        addToChat("right", msgText, "");
        insertLoadingDots();
        ttmChat.scrollTop += 200;
        ttmInput.value = "";

        const selectBox = document.getElementById("input_source");

        if (document.getElementsByTagName("option")[idx].value === '0') {
            botResponse(msgText, custom_input = '0');

            if (msgText == "quit") {
                changeBtnColor(false);
            }
        } else if (document.getElementsByTagName("option")[idx].value === '1') {
            selectBox.selectedIndex = "0";
            botResponse(msgText, custom_input = '1');
            changeBtnColor(true);
        } else {
            selectBox.selectedIndex = "0";
            botResponse(msgText, custom_input = '2');
        }
    });

    function changeBtnColor(flag) {
        let ids = ["c_feat_sent", "c_feat", "c_pred"]

        if (flag) {
            ids.forEach(id => {
                document.getElementById(id).style.border = "5px solid yellow";
            });
        } else {
            ids.forEach(id => {
                document.getElementById(id).style.border = "";
            });
        }
    }

    function answeredNo(logText) {
        // Fade out
        $('.all-feedback').fadeOut(250, function () {
            $('.all-feedback').remove();
        });

        const feedback = `MessageID: ${logText} || Feedback: Negative || Username: {{ currentUserId }}`;
        logFeedback(feedback);
    }

    function answeredInsight(logText) {
        $('.all-feedback').fadeOut(250, function () {
            $('.all-feedback').remove();
        });

        const feedback = `MessageID: ${logText} || Feedback: Insightful || Username: {{ currentUserId }}`;
        logFeedback(feedback);
    }

    function answeredConfused(logText) {
        // Fade out
        $('.all-feedback').fadeOut(250, function () {
            $('.all-feedback').remove();
        });

        const feedback = `MessageID: ${logText} || Feedback: Confused || Username: {{ currentUserId }}`;
        logFeedback(feedback);
    }

    function answeredYes(logText) {
        // Fade out
        $('.all-feedback').fadeOut(250, function () {
            $('.all-feedback').remove();
        });
        const feedback = `MessageID: ${logText} || Feedback: Positive || Username: {{ currentUserId }}`;
        logFeedback(feedback);
    }

    function insertLoadingDots() {
        let msgHTML = `
            <div class="loading-dots", id="current-dots">
                <div class="msg left-msg">
                    <div class="msg-bubble">
                        <div class="stage">
                             <div class="dot-pulse"></div>
                        </div>
                    </div>
                </div>
            </div>
          `
        ttmChat.insertAdjacentHTML("beforeend", msgHTML);
    }

    function deleteLoadingDots() {
        document.getElementById("current-dots").outerHTML = "";
    }

    function pinMessage(text) {
        let msgHTML = `
            <div class="msg left-msg">
              <div class="msg-bubble">
                <div class="msg-text">${text}</div>
              </div>
            </div>
        `;
        ttmPins.insertAdjacentHTML("beforeend", msgHTML);
    }

    function addToChat(side, text, logText) {
        // Defines adding messages to the conversation
        let msgHTML = "";

        // replace quotes for pinned messages, there are some issues with have quotes in here
        let modifiedText = text.replace("\"", "");
        modifiedText = modifiedText.replace("'", "");

        // modifiedText = modifiedText.replace("(", "");
        // modifiedText = modifiedText.replace(")", "");
        if (side == "left") {
            msgHTML = `
            <div class="msg ${side}-msg">
              <div class="msg-bubble">
                <div class="msg-text">${text}</div>
              <div class="happy-sad-unsure-response">
                <div class="all-feedback">
                <div class="feedback-opener">
                    Feedback
                  </div>
                   <div class="feedback-form" >
                        <button title="positive" class="unhappy-button" id="yesbutton" onclick="answeredYes('${logText}');">üëç</button>
                        <button title="negative" class="unhappy-button" id="nobutton" onclick="answeredNo('${logText}');">üëé</button>
                        <button title="insightful" class="unhappy-button" id="insightbutton" onclick="answeredInsight('${logText}');">üí°</button>
                        <button title="confused" class="unhappy-button" id="confusedbutton" onclick="answeredConfused('${logText}');">üòï</button>
                    </div>
                </div>
                  <div class="pin-button">
                    <svg onclick="pinMessage('${modifiedText}')" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pin-angle-fill" viewBox="0 0 16 16">
                      <path d="M9.828.722a.5.5 0 0 1 .354.146l4.95 4.95a.5.5 0 0 1 0 .707c-.48.48-1.072.588-1.503.588-.177 0-.335-.018-.46-.039l-3.134 3.134a5.927 5.927 0 0 1 .16 1.013c.046.702-.032 1.687-.72 2.375a.5.5 0 0 1-.707 0l-2.829-2.828-3.182 3.182c-.195.195-1.219.902-1.414.707-.195-.195.512-1.22.707-1.414l3.182-3.182-2.828-2.829a.5.5 0 0 1 0-.707c.688-.688 1.673-.767 2.375-.72a5.922 5.922 0 0 1 1.013.16l3.134-3.133a2.772 2.772 0 0 1-.04-.461c0-.43.108-1.022.589-1.503a.5.5 0 0 1 .353-.146z"/>
                    </svg>
                  </div>
              </div>
            </div>
            </div>
            `;
            ttmChat.insertAdjacentHTML("beforeend", msgHTML);
            document.addEventListener("click", doReact);

            function doReact(event) {
                let feedback = document.querySelector("div.feedback-opener");
                let isClickInside = feedback.contains(event.target);
                if (isClickInside) {
                    let right = feedback.getBoundingClientRect().right
                    let bottom = feedback.getBoundingClientRect().bottom
                    let feedbackFrom = document.querySelector("div.feedback-form");
                    feedbackFrom.style.display = "block";
                    ttmChat.scrollTop += 200;
                } else {
                    let feedbackFrom = document.querySelector("div.feedback-form");
                    feedbackFrom.style.display = "none";
                }
            }
        } else {
            userInputIndex = userInputs.push(text);
            msgHTML = `
              <div class="msg ${side}-msg">
                <div class="msg-bubble">
                  <div class="msg-text">${text}</div>
                </div>
              </div>
              `;
            ttmChat.insertAdjacentHTML("beforeend", msgHTML);
        }
        ttmChat.scrollTop += 500;
    }

    function botResponse(rawText, custom_input) {

        let dataPackage = {userInput: rawText, userName: "{{ currentUserId }}", custom_input: custom_input}
        dataPackage = JSON.stringify(dataPackage)
        $('.all-feedback').fadeOut(250, function () {
            $('.all-feedback').remove();
        });
        const result = $.ajax({
            type: 'POST',
            url: "{{ url_for('.get_bot_response') }}",
            data: dataPackage,
            processData: false,
            contentType: false,
            cache: false,
            success: function (data) {
                const splitData = data.split('<>')
                const msgText = splitData[0];
                const logText = splitData[1];
                deleteLoadingDots();
                addToChat("left", msgText, logText);
            }
        });
    }

    function get(selector, root = document) {
        return root.querySelector(selector);
    }
</script>

<script>
    function logFeedback(feedback) {
        result = $.ajax({
            type: 'POST',
            url: "{{ url_for('.log_feedback') }}",
            data: feedback,
            processData: false,
            contentType: false,
            cache: false,
        });
    }


    // Handle key cycling
    document.onkeydown = checkKey;

    function checkKey(e) {
        e = e || window;


        if (e.keyCode == '38') {
            // up arrow
            if (userInputs.length == 0) {
                return
            }
            userInputIndex = userInputIndex - 1;
            if (userInputIndex < 0) {
                userInputIndex = 0;
            }
            ttmInput.value = userInputs[userInputIndex];
        } else if (e.keyCode == '40') {
            // down arrow
            if (userInputs.length == 0) {
                return
            }
            userInputIndex = userInputIndex + 1;
            if (userInputIndex > userInputs.length - 1) {
                userInputIndex = userInputs.length - 1;
            }
            ttmInput.value = userInputs[userInputIndex];
        }
    }
</script>
<script>
    function getAllIndexes(arr, val) {
        let indexes = [], i;
        for (i = 0; i < arr.length; i++)
            if (arr[i].includes(val))
                indexes.push(i);
        return indexes;
    }

    // Filter dataset
    const filterDataForm = get(".filterdata-inputarea");
    const filterDataInput = get(".filterdata-input");
    filterDataForm.addEventListener("keyup", event => {
        event.preventDefault();
        const filterMsgText = filterDataInput.value;
        result = $.ajax({
            type: 'POST',
            url: "{{ url_for('.filter_dataset') }}",
            data: JSON.stringify({
                'filterMsgText': filterMsgText,
            }),
            processData: false,
            contentType: 'application/json',
            cache: false,
            success: function (info) {
                var data = JSON.parse(info["jsonData"]);
                var data_size = Object.keys(data).length;

                var msgHTML = data_size + " out of " + info["totalDataLen"] + " data points:<br>";
                var numDisplayed = 0;
                const span_start = "<span style='background-color: yellow'>";
                const span_end = "</span>";

                for (let [id, entry] of Object.entries(data)) {
                    msgHTML += "<details style='margin-top: 1px;'"
                    if (numDisplayed == 0) {
                        msgHTML += " open='true';"
                    }
                    msgHTML += "><summary>";
                    msgHTML += "<b>ID:" + id + "</b></summary>";

                    for (let [field_name, field_content] of Object.entries(entry)) {
                        msgHTML += "<b>" + field_name + ": </b>"
                        msgHTML += "<div style='font-style: italic; font-size: 0.75em;'>";
                        // + field_content
                        if (field_content.includes(filterMsgText) && filterMsgText.length > 0) {
                            let field_content_arr = field_content.split(" ");
                            let idx = getAllIndexes(field_content_arr, filterMsgText);

                            let last_pointer = 0;
                            for (let i = 0; i < idx.length; i++) {
                                if (idx[i] == 0) {
                                    msgHTML += span_start;
                                    msgHTML += field_content_arr[idx[i]];
                                    msgHTML += span_end;
                                    msgHTML += " ";
                                    last_pointer = 1;
                                } else if (idx.length > 1 && idx[i] == field_content_arr.length - 1) {
                                    msgHTML += span_start;
                                    msgHTML += field_content_arr[idx[i]];
                                    msgHTML += span_end;
                                    msgHTML += " ";
                                    last_pointer = 1;
                                } else if (idx.length == 1 && idx[i] == field_content_arr.length - 1) {
                                    for (let i = 0; i < idx[0]; i++) {
                                        msgHTML += field_content_arr[i];
                                        msgHTML += " ";
                                    }

                                    msgHTML += span_start;
                                    msgHTML += field_content_arr[idx[i]];
                                    msgHTML += span_end;
                                    msgHTML += " ";
                                    last_pointer = idx[i];
                                } else {

                                    for (let j = last_pointer; j < idx[i]; j++) {
                                        msgHTML += field_content_arr[j];
                                        msgHTML += " ";
                                    }

                                    msgHTML += span_start;
                                    msgHTML += field_content_arr[idx[i]];
                                    msgHTML += span_end;
                                    msgHTML += " ";
                                    last_pointer = idx[i] + 1;
                                }
                            }

                            if (idx[idx.length - 1] < field_content_arr.length) {
                                for (let i = idx[idx.length - 1] + 1; i < field_content_arr.length; i++) {
                                    msgHTML += field_content_arr[i];
                                    msgHTML += " ";
                                }
                            }
                        } else {
                            msgHTML += field_content;
                        }
                        msgHTML += "</div>";
                    }
                    msgHTML += "</details>"

                    numDisplayed += 1;
                    if (numDisplayed >= 10) {
                        msgHTML += "<br>(Showing first 10)";
                        break
                    }
                }
                document.getElementById("show_data").innerHTML = msgHTML;
            }
        })
    });
</script>
